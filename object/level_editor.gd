extends Node2D
	
const in_edit_mode: bool = false
var current_level_name = "G-DRAGON - TOO BAD"

var fk_fall_time: float = 1.1
var fk_output_arr = [[], [], [], []]

var level_info = {
	"G-DRAGON - TOO BAD" = {
		"fk_times": "[[-0.95208616256714, 2.66374139785767, 3.27170066833496, 4.61562376022339, 5.25560073852539, 6.87684803009033, 9.46870784759522, 10.6739681243896, 11.2712696075439, 12.7645347595215, 13.3298414230347, 14.7697513580322, 15.8043773651123, 16.2950122833252, 18.0975730895996, 20.1241271972656, 20.2734687805176, 20.4121311187744, 21.4467342376709, 22.9293201446533, 24.8918827056885, 27.0677783966064, 28.2090480804443, 28.379704284668, 28.5183666229248, 31.0142181396484, 33.5634239196777, 34.8433578491211, 36.2192733764648, 38.9071434020996, 39.8777549743652, 41.5949905395508, 43.6748741149902, 44.5921752929687, 45.8187759399414, 48.0479820251465, 49.1252601623535, 51.3438079833984, 53.3703620910645, 54.1063278198242, 54.6609733581543, 54.8209541320801, 54.9489562988281, 57.4128120422363, 59.4500434875488, 61.7219284057617, 63.492497253418, 66.4470031738281, 67.3536270141602, 69.1455352783203, 72.7293441772461, 72.9959838867187, 75.3425415039062, 77.3477523803711, 79.374333190918, 80.8249176025391, 81.0915649414062, 84.0140808105469, 86.1473052978516, 86.7552612304687, 87.9498641967773, 88.749821472168, 89.99775390625, 90.7977111816406, 92.3016326904297, 93.0482528686523, 94.0722015380859, 94.7868240356445, 96.1520889282227, 96.4720886230469, 97.922673034668, 100.802517700195, 102.647755432129, 104.26900177002, 106.284901428223, 107.084851074219, 108.300793457031, 110.380680847168, 111.62861328125, 111.777935791016, 111.895260620117, 112.300564575195, 114.401791381836, 116.140362548828, 118.017597961426, 119.542858886719, 119.756169128418, 120.001499938965, 122.102719116211, 123.595967102051, 123.755963134766, 123.894627380371, 124.171948242188, 127.638409423828, 127.873089599609, 128.385052490234, 130.219616699219, 132.299496459961, 134.848706054688, 138.283200073242, 140.395077514648, 142.549633789063, 146.496075439453], [-0.34410436153412, 2.89839010238647, 3.66634922027588, 4.86095218658447, 6.64217643737793, 7.28215389251709, 8.79673461914063, 9.69269828796387, 10.9512928009033, 11.6445806503296, 11.9752376556396, 12.2418821334839, 13.0418365478516, 13.8204753875732, 14.1191165924072, 14.3431060791016, 15.0043991088867, 16.028343963623, 16.8176410675049, 18.3429019927979, 19.5055110931396, 20.7960994720459, 23.1959636688232, 24.1452606201172, 24.475895690918, 24.5932434082031, 25.4251926422119, 27.6437423706055, 28.2090480804443, 28.379704284668, 28.5183666229248, 29.2756469726563, 31.280884552002, 33.0621078491211, 35.6006591796875, 36.5285957336426, 37.6485488891602, 39.1417930603027, 40.2617233276367, 40.9656913757324, 42.9922454833984, 43.3110893249512, 44.2935150146484, 45.0401351928711, 47.0453727722168, 47.3226974487305, 48.3999755859375, 48.6559646606445, 49.8398864746094, 51.9944427490234, 53.7970054626465, 54.1063278198242, 54.6609733581543, 54.8209541320801, 54.9489562988281, 55.7915657043457, 57.8927886962891, 60.1220176696777, 60.761971282959, 60.9219711303711, 61.0926292419434, 62.2232406616211, 63.7911575317383, 65.6257141113281, 67.7162826538086, 69.6255081176758, 71.6947372436523, 73.3266418457031, 75.811833190918, 77.8277328491211, 79.8756225585937, 81.6675308227539, 82.9048049926758, 83.1501129150391, 84.6647155761719, 86.7446029663086, 88.4191864013672, 90.424397277832, 91.1710174560547, 92.7069366455078, 94.4241912841797, 95.1174819946289, 96.8027236938477, 100.226551818848, 102.199772644043, 103.053059387207, 104.524990844727, 105.484944152832, 105.879566955566, 106.796871948242, 107.554150390625, 107.820812988281, 108.951405334473, 110.721997070313, 111.62861328125, 111.777935791016, 111.895260620117, 112.620541381836, 113.623173522949, 113.975148010254, 114.103153991699, 114.871113586426, 116.385693359375, 118.433583068848, 119.542858886719, 119.756169128418, 120.502812194824, 122.550701904297, 123.595967102051, 123.755963134766, 123.894627380371, 124.57725982666, 126.251843261719, 127.873089599609, 130.67825012207, 131.744869995117, 131.97951965332, 132.715481567383, 136.331295776367, 138.816479492188, 140.821728515625, 142.954937744141, 146.869412231445], [0.34918360710144, 2.78106575012207, 3.42102031707764, 4.74362831115723, 5.39426307678223, 6.77018146514893, 7.42081623077393, 8.02877597808838, 8.30609970092774, 8.5300910949707, 8.999387550354, 10.0126760482788, 10.8232877731323, 11.4632652282715, 11.8685710906982, 12.1245582580566, 12.401881980896, 13.1698415756226, 14.8764179229736, 15.9430168151855, 16.4123352050781, 17.6495922088623, 18.8655326843262, 19.1215198516846, 21.0947616577148, 23.0679824829102, 24.1559188842773, 24.475895690918, 24.6252372741699, 25.3185260772705, 26.2571437835693, 26.4491374969482, 26.57712059021, 27.2810886383057, 29.0623348236084, 29.8196151733398, 30.2675979614258, 30.4489105224609, 30.608910369873, 31.1635597229004, 33.4460990905762, 33.8727424621582, 35.2806594848633, 36.3259399414062, 37.2538993835449, 39.0244682312012, 39.6431053161621, 40.4537170410156, 41.3283432006836, 43.1629035949707, 43.5148971557617, 44.4001815795898, 45.3601348876953, 46.0427673339844, 47.8133323669434, 48.2399757385254, 48.5173004150391, 48.9119499206543, 50.2451942443848, 51.5997970581055, 52.6770751953125, 52.8690689086914, 53.018391418457, 53.5943534851074, 55.5995910644531, 56.6981857299805, 56.9755104064941, 57.1248291015625, 58.2234466552734, 58.7460754394531, 58.9274147033691, 59.0767333984375, 59.7060325622559, 60.7406356811523, 60.9219711303711, 61.1139686584473, 61.9672592163086, 63.6418121337891, 64.8150985717773, 65.1244247436523, 65.9777114868164, 67.5029495239258, 69.412174987793, 70.96943359375, 72.8573272705078, 73.742626953125, 75.5558517456055, 76.8784606933594, 77.1131103515625, 78.9050109863281, 79.1396606445312, 81.4648788452148, 83.0434692382812, 84.3233993530273, 86.456623840332, 88.1036270141602, 89.0591400146484, 90.6270492553711, 91.3736770629883, 92.5576217651367, 94.530842590332, 96.2374160766602, 96.5680740356445, 97.954670715332, 100.429203796387, 101.549137878418, 101.741131591797, 102.925076293945, 104.386326599121, 105.826260375977, 105.975575256348, 106.647526550293, 108.588772583008, 109.634037780762, 109.804692077637, 109.954037475586, 110.625988769531, 112.481907653809, 113.623173522949, 113.975148010254, 114.135144042969, 115.180409240723, 116.204350280762, 117.516300964355, 117.750950622559, 118.252247619629, 120.278820800781, 121.846737670898, 123.62795715332, 123.77730255127, 123.915966796875, 125.654537963867, 126.433148193359, 129.718319702148, 129.995617675781, 130.475598144531, 131.755535888672, 132.000866699219, 134.400723266602, 136.58727722168, 138.603176879883, 139.947094726563, 140.096417236328, 140.597729492188, 142.752285766602, 144.768185424805, 146.69875793457], [1.05315189361572, 3.14369611740112, 3.80501155853271, 5.14893417358398, 5.85290222167969, 7.17548732757568, 7.90079383850098, 8.19943313598633, 8.44476203918457, 9.55403594970703, 10.1726758956909, 11.1219499588013, 12.9138544082642, 13.5218141555786, 13.9164627075195, 14.2257831573486, 14.4711120605469, 15.1430614471436, 16.1776874542236, 17.20163230896, 18.2468936920166, 19.6441715240479, 21.6493881225586, 22.1720188140869, 22.3426750183105, 22.4813373565674, 23.6226070404053, 25.7238319396973, 26.2571437835693, 26.427799987793, 26.57712059021, 27.7610652923584, 29.6489570617676, 30.2675979614258, 30.4275978088379, 30.608910369873, 31.7288444519043, 32.3154876708984, 32.560814666748, 32.7207954406738, 35.9206359863281, 36.8272560119629, 38.0431755065918, 39.3017929077148, 40.0910652160645, 40.7416999816895, 42.1922920227051, 44.0055320739746, 44.7948310852051, 45.6161239624023, 47.1413619995117, 47.4613616943359, 49.4559181213379, 50.6291854858398, 50.7785041809082, 50.9171646118164, 52.1224258422852, 52.6770751953125, 52.8690689086914, 53.018391418457, 55.439591217041, 56.1435592651367, 57.7648056030273, 58.7460754394531, 58.9167335510254, 59.0767333984375, 60.29267578125, 61.5192726135254, 62.7565277099609, 62.9591873168945, 63.1191833496094, 64.2924468994141, 65.3057373046875, 66.2016799926758, 68.6228988647461, 68.8895462036133, 70.7241027832031, 71.2040832519531, 71.4707458496094, 73.5186431884766, 74.8092315673828, 74.9585464477539, 75.0972106933594, 77.593083190918, 79.6409729003906, 81.870182800293, 83.6407745361328, 84.9633529663086, 86.0619705200195, 87.0005920410156, 88.5471618652344, 90.1044204711914, 90.9683654785156, 92.173649597168, 92.8775985717773, 94.1682098388672, 94.92548828125, 97.0053756713867, 99.4372528076172, 99.5972564697266, 99.7465789794922, 100.941181945801, 102.423764038086, 103.490361022949, 103.650364685059, 103.79967956543, 104.940953063965, 105.484944152832, 105.826260375977, 106.028912353516, 109.079411315918, 109.623379516602, 109.804692077637, 109.954037475586, 111.041973876953, 113.068524169922, 114.721768188477, 117.516300964355, 117.750950622559, 121.569409179688, 122.326710510254, 124.353268432617, 125.771862792969, 128.630368041992, 129.718319702148, 129.995617675781, 132.491497802734, 134.624722290039, 136.821926879883, 139.947094726563, 140.096417236328, 144.554852294922, 144.970837402344]]
",
		"music": load("res://music/G-DRAGON - TOO BAD.wav")
	}
}

func _ready():
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		print(fk_times_arr[0])
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
					0:
						button_name = "button_Z"
					1:
						button_name = "button_X"
					2:
						button_name = "button_N"
					3:
						button_name = "button_M"

			for delay in key:
				SpawnFallingKey(button_name, delay)
				
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	#print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreatFallingKey.emit(button_name)

func _on_music_player_finished():
	print(fk_output_arr)
